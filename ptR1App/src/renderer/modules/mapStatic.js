// modules/mapStatic.js
import { startPatrolState, stopPatrolState, patrolPath } from './patrolState.js';

import { activeMap } from './mapState.js';

import { setMapImage } from './mapHome.js';



let canvas, ctx;
let mapImage = null;
let zoom = 1.0;
let offsetX = 0;
let offsetY = 0;
let isDragging = false;
let isDrawing = false; // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ô‡∏µ‡πâ
let dragStartX = 0;
let dragStartY = 0;

let current_map_select = { name: null, base64: null };
let goalPoint = null;
let mode = 'none';

export function initStaticMap() {
  canvas = document.getElementById('staticMapCanvas');
  ctx = canvas.getContext('2d');

  bindUI();
  setupCanvasEvents();
  loadLocalMapsToGallery(); // initial load
}

document.getElementById('select-map-btn').addEventListener('click', async () => {
  if (!current_map_select.name) {
    alert("‚ùó No map selected");
    return;
  }

  // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Active Map State (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
  activeMap.name = current_map_select.name;
  activeMap.base64 = current_map_select.base64; // base64 ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ 'data:image/...'
  document.getElementById('active-map-name').textContent = activeMap.name;
  console.log(`üó∫Ô∏è Selected Map: ${activeMap.name}`);

  localStorage.setItem('activeMapName', activeMap.name);
  console.log(`üíæ Saved active map '${activeMap.name}' to localStorage.`);

  // --- ‡πÇ‡∏´‡∏•‡∏î Meta Data (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
  const result = await window.electronAPI.getMapMeta(activeMap.name);
  if (result.success) {
    activeMap.meta = result.data;
    console.log("‚úÖ Loaded map meta:", result.data);
  } else {
    console.warn("‚ùå Failed to load map meta:", result.message);
    activeMap.meta = null; // Reset meta ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
  }

  // ‚úÖ 3. ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏°‡∏î‡∏π‡∏• mapHome ‡∏ß‡∏≤‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
  // ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡πà‡∏á‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• base64 ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß 'data:image/png;base64,' ‡πÑ‡∏õ
  // ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô setMapImage ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á
  if (activeMap.base64) {
    await setMapImage(activeMap.base64);
  }

  // --- ‡∏™‡∏±‡πà‡∏á‡πÉ‡∏´‡πâ Main Process ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô ROS (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
  window.electronAPI.selectMap(activeMap.name);
});

async function loadActiveMapMeta() {
  if (!activeMap?.name) return;

  const result = await window.electronAPI.getMapMeta(activeMap.name);
  if (result.success) {
    activeMap.meta = result.data;  // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏° meta ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    console.log("‚úÖ Loaded map meta:", result.data);
  } else {
    console.warn("‚ùå Failed to load map meta:", result.message);
  }
}

function renderHomeCanvas() {
  const canvas = document.getElementById('homeMapCanvas');
  if (!canvas || !activeMap?.base64 || !activeMap?.meta || !robotPose) return;

  const ctx = canvas.getContext('2d');
  const width = canvas.width = canvas.clientWidth;
  const height = canvas.height = canvas.clientHeight;

  const mapImg = new Image();
  mapImg.onload = () => {
    ctx.clearRect(0, 0, width, height);

    drawMap(ctx, canvas, mapImg);
    drawPatrolPath(ctx, canvas, mapImg);
    drawRobot(ctx, canvas, mapImg);
  };
  mapImg.src = activeMap.base64;
}

function bindUI() {
  document.getElementById('zoom-in').addEventListener('click', () => {
    if (mapImage) {
      zoom = Math.min(zoom * 1.2, 10);
      renderCanvas();
    }
  });

  document.getElementById('zoom-out').addEventListener('click', () => {
    if (mapImage) {
      zoom = Math.max(zoom / 1.2, 0.1);
      renderCanvas();
    }
  });

  document.getElementById('reset-view').addEventListener('click', () => {
    zoom = 1.0;
    offsetX = 0;
    offsetY = 0;
    renderCanvas();
  });

  document.getElementById('clear-path-btn').addEventListener('click', () => {
    patrolPath.length = 0;
    goalPoint = null;
    cancelMode();
    renderCanvas();
    console.log('üìç Cleared Path and Goal');
  });

  document.getElementById('save-path-btn').addEventListener('click', () => {
    console.log('üíæ Saved Path:', patrolPath);
    window.electronAPI.sendPatrolPath(patrolPath);
  });

  document.getElementById('start-patrol-btn').addEventListener('click', startPatrol);
  document.getElementById('stop-patrol-btn').addEventListener('click', stopPatrol);


  document.getElementById('sync-maps-btn').addEventListener('click', () => {
    window.electronAPI.syncMaps();
  });

  document.getElementById('set-goal-btn').addEventListener('click', () => {
    if (mode === 'goal') {
      cancelMode();
      return;
    }
    
    //‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á (Draw Path)
    patrolPath.length = 0;
    console.log('Cleared Patrol Path');
    
    //Reset UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    cancelMode(); 
    
    //‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î Goal
    mode = 'goal';
    canvas.style.cursor = 'crosshair';
    document.getElementById('set-goal-btn').classList.add('active');
    
    renderCanvas();
  });

  const drawModeBtn = document.getElementById('toggle-draw-mode');
  drawModeBtn.addEventListener('click', () => {
    if (mode === 'draw') {
      cancelMode();
      return;
    }
    
    //‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡∏±‡πà‡∏á (Goal Point)
    goalPoint = null;
    console.log('Cleared Goal Point');

    //Reset UI ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
    cancelMode();

    //‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏´‡∏°‡∏î Draw
    mode = 'draw';
    canvas.style.cursor = 'crosshair';
    drawModeBtn.textContent = 'Draw :ON';
    drawModeBtn.classList.add('active');
    
    //‡∏ß‡∏≤‡∏î Canvas ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Goal Marker ‡∏ó‡∏µ‡πà‡∏•‡∏ö‡∏´‡∏≤‡∏¢‡πÑ‡∏õ
    patrolPath.length = 0; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå path ‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
    renderCanvas();
    });

  window.electronAPI.onSyncComplete((mapList) => {
    const gallery = document.getElementById('map-gallery');
    gallery.innerHTML = '';
    mapList.forEach(({ name, base64 }) => addMapToGallery(name, base64));
    loadLocalMapsToGallery();
  });
}

function setupCanvasEvents() {
   canvas.addEventListener('mousedown', (e) => {
    if (mode === 'draw') {
      isDrawing = true;
      addPathPoint(e); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
      renderCanvas();
    } else {
      isDragging = true;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
    }
  });

  canvas.addEventListener('mouseup', () => {
    isDrawing = false; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå
    isDragging = false;
  });

  canvas.addEventListener('mouseleave', () => {
    isDrawing = false; // ‡∏´‡∏¢‡∏∏‡∏î‡∏ß‡∏≤‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Canvas
    isDragging = false;
  });

  canvas.addEventListener('mousemove', (e) => {

    if (isDrawing) {
      addPathPoint(e); 
      renderCanvas();
      return; 
    }

    if (!isDragging) return;
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    dragStartX = e.clientX;
    dragStartY = e.clientY;

    offsetX += dx;
    offsetY += dy;
    renderCanvas();
  });

    
  canvas.addEventListener('mousedown', (e) => {
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
  });

  canvas.addEventListener('mouseup', () => isDragging = false);
  canvas.addEventListener('mouseleave', () => isDragging = false);

  canvas.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    dragStartX = e.clientX;
    dragStartY = e.clientY;

    offsetX += dx;
    offsetY += dy;
    renderCanvas();
  });

  canvas.addEventListener('wheel', (e) => {
    if (!mapImage) return;
    e.preventDefault();
    const zoomFactor = 1.1;
    const oldZoom = zoom;

    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left - canvas.width / 2;
    const my = e.clientY - rect.top - canvas.height / 2;

    zoom = e.deltaY < 0
      ? Math.min(zoom * zoomFactor, 10)
      : Math.max(zoom / zoomFactor, 0.1);

    const scale = zoom / oldZoom;
    offsetX = mx - (mx - offsetX) * scale;
    offsetY = my - (my - offsetY) * scale;

    renderCanvas();
  });

  canvas.addEventListener('click', (e) => {
    if (isDragging || mode !== 'goal') return;

    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left - canvas.width / 2;
    const clickY = e.clientY - rect.top - canvas.height / 2;

    const mapX = (clickX - offsetX) / zoom;
    const mapY = (clickY - offsetY) / zoom;

    goalPoint = { x: mapX, y: mapY };
    console.log('üéØ Goal Point:', goalPoint);
    renderCanvas();
    cancelMode();
  });

  window.addEventListener('resize', () => renderCanvas());

  canvas.addEventListener('contextmenu', (e) => {
    if (mode !== 'none') {
      e.preventDefault();
      cancelMode();
    }
  });

  document.addEventListener('click', (e) => {
    if (
      mode === 'goal' &&
      !canvas.contains(e.target) &&
      !document.getElementById('set-goal-btn').contains(e.target)
    ) {
      cancelMode();
    }
  });
}

function cancelMode() {
  mode = 'none';
  isDrawing = false;
  canvas.style.cursor = 'default';

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° "Set Goal"
  document.getElementById('set-goal-btn').classList.remove('active');
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏° "Draw"
  const drawModeBtn = document.getElementById('toggle-draw-mode');
  drawModeBtn.textContent = 'Draw :OFF';
  drawModeBtn.classList.remove('active');
  
  renderCanvas();
}

function addPathPoint(e) {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left - canvas.width / 2;
  const clickY = e.clientY - rect.top - canvas.height / 2;

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á zoom/pan)
  const mapX = (clickX - offsetX) / zoom;
  const mapY = (clickY - offsetY) / zoom;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
  const newPoint = { x: mapX, y: mapY };

  console.log(`üìç Added point: X=${newPoint.x.toFixed(3)}, Y=${newPoint.y.toFixed(3)}`);

  patrolPath.push({ x: mapX, y: mapY });
  console.log('üìú Current full path:', patrolPath);
}

function renderCanvas() {
  if (!mapImage) return;
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const imgW = mapImage.width * zoom;
  const imgH = mapImage.height * zoom;
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;

  ctx.drawImage(
    mapImage,
    cx - imgW / 2 + offsetX,
    cy - imgH / 2 + offsetY,
    imgW,
    imgH
  );

  // üî∂ ‡∏ß‡∏≤‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  if (current_map_select.name) {
    ctx.font = '16px sans-serif';
    ctx.fillStyle = 'white';
    ctx.fillText(`Map: ${current_map_select.name}`, 10, 10);
  }

  // üü† ‡∏ß‡∏≤‡∏î path
  if (patrolPath.length > 0) {
    ctx.strokeStyle = 'orange';
    ctx.lineWidth = 2;
    ctx.beginPath();
    patrolPath.forEach((pt, i) => {
      const x = cx + pt.x * zoom + offsetX;
      const y = cy + pt.y * zoom + offsetY;
      i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
    });
    ctx.closePath();
    ctx.stroke();

    ctx.fillStyle = 'cyan';
    patrolPath.forEach((pt) => {
      const x = cx + pt.x * zoom + offsetX;
      const y = cy + pt.y * zoom + offsetY;
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, Math.PI * 2);
      ctx.fill();
    });
  }

  // üéØ goal point
  if (goalPoint) {
    const x = cx + goalPoint.x * zoom + offsetX;
    const y = cy + goalPoint.y * zoom + offsetY;
    ctx.beginPath();
    ctx.arc(x, y, 6, 0, 2 * Math.PI);
    ctx.fillStyle = 'red';
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = 'white';
    ctx.stroke();
  }
}

function loadLocalMapsToGallery() {
  window.electronAPI.getLocalMaps().then((maps) => {
    const gallery = document.getElementById('map-gallery');
    gallery.innerHTML = '';
    maps.forEach(({ name, base64 }) => addMapToGallery(name, base64));
  });
}

function addMapToGallery(name, base64) {
  const img = document.createElement('img');
  img.src = base64;
  img.alt = name;
  img.title = name;
  img.className = 'map-thumb';
  img.style.cursor = 'pointer';

  img.addEventListener('click', () => {
    mapImage = new Image();
    mapImage.onload = renderCanvas;
    mapImage.src = base64;
    current_map_select = { name, base64 };
  });

  document.getElementById('map-gallery').appendChild(img);
}

function startPatrol() {
  if (patrolPath.length < 2) {
    console.warn('‚ö†Ô∏è Path is too short to start patrol. Please draw a longer path.');
    alert('Please draw a path with at least 2 points.');
    return;
  }
  
  console.log('‚ñ∂Ô∏è Starting patrol with path:', patrolPath);
  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
  startPatrolState(patrolPath);
  
  //‡∏™‡πà‡∏á path ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ Backend/Robot
  window.electronAPI.sendPatrolPath(patrolPath); 
  
  // log ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏£‡∏Å
  const currentGoal = patrolPath[0];
  console.log(`üèÅ First goal is: X=${currentGoal.x.toFixed(3)}, Y=${currentGoal.y.toFixed(3)}`);
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏ï‡∏£‡∏∞‡πÄ‡∏ß‡∏ô (Patrol)
 */
function stopPatrol() {
  console.log('üõë Stopping patrol...');

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï State ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á
  stopPatrolState();

  // ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ Backend/Robot
  window.electronAPI.sendStopPatrol();
}